---
title: "約3年間Flutter で開発してきてのあれやこれや"
emoji: "💬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Flutter"]
published: true
---

約一年ぶりくらいの記事になります。

去年や一昨年はFlutter 関係で色々な記事を書いていましたが、最近では状態管理の方法もProvider やReverpod で落ち着いていたり、プラグインも増えて色々なことができるようになってあまり記事を書いていませんでしたが、ここ１年２年で気がついたことや変わったことについて書いていけたらいいな〜と思います。

# CI/CD について

私が最近開発を担当しているアプリではGitHub Actions とCodemagic を使用しています。
特に特殊な構成ではないので、目新しさはないかもしれませんが、色々と考えていわゆるDXの向上に努めています。

### Github Actions

Github Actions ではPush のたびに `dart analyze .` と`dart format --fix -l 100 .` を実行しています。
Github Actions とFlutter の組み合わせの場合、 [subosito/flutter-action](https://github.com/subosito/flutter-action) を使っている方が多いかと思いますが、本プロジェクトでは`subosito/flutter-action` を使用していません。

[Flutter の公式ドキュメン](https://docs.flutter.dev/get-started/install/macos#downloading-straight-from-github-instead-of-using-an-archive)に記載されているようにFlutter のインストールはGitHub から行えます。
`git clone https://github.com/flutter/flutter.git -b stable` でインストールできること利用してubuntu 上にFlutter をインストールして analyze やformat を実行しています。
サンプルとして実際に動作しているものを掲載しておきます。よかったら参考にしてください。


```yaml
name: Lint & Analyze

on:
  push:
    paths-ignore:
      - "**.md"

jobs:
  analyze:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pushed commit
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}
          submodules: true
          ref: ${{ github.event.pull_request.head.sha }}
      - name: "Install Flutter"
        run: ./.github/workflows/scripts/install-flutter.sh stable
      - name: "flutter pub get"
        run: flutter pub get
      - name: Analyze
        run: dart analyze . --fatal-infos
      - name: Format
        run: dart format --fix -l 100
```

上記のような書き方は [flutterfire](https://github.com/firebaseextended/flutterfire) を参考にしています。  
Flutter で有名なライブラリなどは色々なツールや書き方をしているので、一度見てみても面白いかもしれません。
上記のまま導入して実行してもinstall-flutter.sh に実行権限が無いため、ワークフローが失敗します。

```
git update-index --add --chmod=+x install-flutter.sh
```

で実行権限を付与して commit とpush をしてください。



### Codemagic

Codemagic はGitHub 上でリリースタグが作成されると自動的にビルドしてAppStoreConnectとGooglePlayConsole 上にアップロードされるようになっています。

社内テスト用として、TestFlightや Firebase App Distribution を使用していますが、テスト用ににビルドするといったworkflow は準備していません。
QAの方や運営の方に確認していただく際にはTestFlightや Firebase App Distribution に公開してインストールしていただいていますが、普段はほぼ一人で開発している状態のため手元でビルドして実機にインストールしステークホルダーの方に確認していただくといったフローのため、テスト用ににビルドするといったworkflow は準備していません。
Codemagic を使用している理由としては他の方が開発に携わった際にバージョンとビルド番号に齟齬がないようにといった理由で採用しています。

また、ビルド番号でサーバーからのレスポンスが変わることがあるので、想定したビルド番号より小さいと機能が足りなかったり、逆に大きと対応出来ていない機能が露出してしまう可能性があるため、ビルド番号の採番はCodemagic に一任しているといった形です。
git のコミット数 + プレフィックスで採番しているので、手元でビルドしてもCodemagic のワークフローの順番にビルドしていけば困ったことにならない想定ではありますが...


Codemagic上でgit のコミット数 + プレフィックス でビルド番号を採番する際に気をつけていただきたいのが、Codemagic ではビルドするプロジェクトをGitHub などからclone しますが、その際に`--depth=1` がついています。
`--depth=1` がついていると、最新のコミットしか取得しないため、ビルド番号が 1 + プレフィックスになってしまいます
そのため、コミットを全件取得するようにするか、github でタグを切った際にビルド番号を採番してpubspec.yaml に反映してください。

# マルチパッケージ

### melos

弊社のほとんどのプロジェクトは何かしらの社内の共通ライブラリに依存しています。
それはFlutter のプロジェクトも然りです。

Flutter でライブラリを使用するには`pubspec.yaml` にライブラリを追加すると使用できます。
追加の方法は複数あり、[pub.dev] (https://pub.dev) に公開するまたは、git のリポジトリを指定したり、path で同じプロジェクト内にあるライブラリを指定したりできます。
３パターンを書き出すと下記のような感じです。

```yaml
dependencies:
  flutter:
    sdk: flutter
  packaeg1: ^1.0.0          # pub.dev に公開
  package2:                 # git 経由
    git:
        url: https://...
        ref: ^1.0.0
  package3:                 # 同一プロジェクト内に配置
    path: ../package3
```

私はpath で指定する方法を好んで使用しており、ディレクトリ構成は下記のようになります。

```
flutter_app/
	packages/
		flutter_app/
			lib/
			tests/
			pubspec.yaml
		commons/
			lib/
		payment_module/
			lib/
```

path で指定すると１つ問題が発生します。その問題とは各ライブラリのルートに行って`flutter pub get` をする必要があるということです。
pub.dev とgit で指定した場合はプロジェクトルートで`flutter pub get` するとライブラリのインストールが完了しますが、
path で指定している場合は各ライブラリのルートに行き`flutter pub get` する必要があります。

1つ程度にしか依存していない場合は、`flutter pub get` するだけのスクリプトを書いてもいいかもしれませんが複数のライブラリに依存するとめんどくさいです。
そういった際に melos があるととても便利です。
melos は始めに `melos bootstrap` というコマンドを実行する必要があります。
`melos bootstrap` を実行するとmelos がプロジェクト内のpubspec.yaml を探しだし各プロジェクトをmelos で操作できるようになります。
たとえは下記のようなスクリプトを用意した際に `melos run pub:get` を実行するとpackages内にある各ライブラリで`flutter pub get` が行われるようになります。

```yaml
packages:
  - packages/**

scripts:
  pub:get:
    run: |
      melos exec -c 1 \
        "flutter pub get"
```

path で指定した際に一番良いと考えることはライブラリの更新がとても楽だと言うことです。
以前はgit で指定する方法を使用していましたがgit 経由でインストールしている場合、コードの変更のたびに`flutter pub get`　が必要になっていました。
melos が出てきたおかげてpath で指定することが容易になり、ライブラリのコードを変更し保存するとHotReload が実行されアプリに反映されるといったFlutter のメリットも最大限活かして開発することが出来ています！
マルチパッケージにしている方は少ないかもしれませんが、アプリが大きくなってきた際にはアプリを分割してぜひmelos を使ってみてください。

# Flutter のバージョン管理について

### fvm

弊社ではできるだけStable チャンネルの最新を使おうとしており、nullsafty に書き換えたプロジェクトのありますが、まだ対応が完了していないプロジェクトもあります。
そういったプロジェクトでは fvm を使用してFlutter のバージョン管理を行っています。
asdf  を使うことも考えましたが、何かしらの理由で採用されませんでした。
理由はすぐに出てきませんでした。見つけたらTwitterでつぶやくのでよかったらフォローお願いします。

https://twitter.com/0maru_dev

# タスクランナー

### grinder

melos を使い初めてビルドや build_runner の実行はもっぱら melos で行いますが、melos ではシェルスクリプト で書くことになってしまうので、Grinder を使用しています。
用途としてはビルド番号を採番してpubspec.yaml のversion を書き換えたり、テスト実行して特定のファイルをカバレッジの結果から取り除いたりといった感じで使用しています。
grinder だと引数を渡せたりするのもいいですね!

Grinder については過去に記事を書いているのでサンプルコードなどは下記のリンクより確認してみてください！

https://qiita.com/0maru/items/b134c5ee319e3cac2a99