---
title: "Flutter でECアプリを新規開発してみて"
emoji: "🦖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Flutter"]
published: false
---

この記事は[株式会社TORICO Advent Calendar 2021](https://qiita.com/advent-calendar/2021/torico) の17日目の記事です。

-----

はじめまして。

株式会社TORICO でモバイルアプリエンジニアをしている[0maru](https://twitter.com/0maru_dev) です。
今回は弊社の主要事業である[漫画全巻ドットコム](https://www.mangazenkan.com/) のモバイルアプリをFlutter で開発したことについて書いていきます。

# はじめに

弊社では４つのモバイルアプリがリリースされており、その全てがFlutter で開発されています。
Git のコミットを遡ってみると初めてのコミットは2019年1月でした。
Flutter のバージョン1.0 がリリースされたのが2018年12月なのでバージョン 1.0 がリリースされてすぐにFlutter の採用を開始していますので、弊社は比較的Flutter の採用が早かった会社ではないでしょうか。

今回開発したのは弊社の主要事業である漫画全巻ドットコムのモバイルアプリです。
漫画全巻ドットコムとは鬼滅の刃なら1~23巻の23巻セットで、ワンピースなら1~101巻の101巻セットで全巻をまとめ買いができるサービスです。
漫画全巻ドットコムでは受注から出荷までワンストップで行われており、漫画は東京の本社に併設されている倉庫から発送されています。
今回は本サービスの紙の漫画を購入できるアプリを開発したことについて書いていきます。

また、本サービスでは電子書籍も取り扱っており、電子書籍のリーダーアプリもFlutter で開発しリリースしていますが今回は触れません。
もしかするともうひとりのアプリエンジニアがアドベントカレンダーで書いてくれるかもしれないので良かったら[株式会社TORICO Advent Calendar 2021](https://qiita.com/advent-calendar/2021/torico) をチェックしてみてください！

# アプリについて

今回の記事ではサンプルコードは少なめです。
CI/CD, マルチパッケージ、Flutter のバージョン管理に関しては別で記事を書いていますので、[約3年間Flutter で開発してきてのあれやこれや](https://zenn.dev/0maru/articles/262c0f8ad52a0d) を確認してください。
まだ実際のコードを掻い摘んで掲載してる為多少おかしいと感じる箇所があるかも知れませんがご了承ください。

## アプリの構成について

本アプリはFirebase などのmBaas などで作っているわけではなく、サーバーサイドはPython とPHP で実装されており、WebAPIでリクエストするようになっています。
HttpClient は[dio]([https://pub.dev/packages/dio](https://pub.dev/packages/dio)) を使用しており、[json_serializable]([https://pub.dev/packages/json_serializable](https://pub.dev/packages/json_serializable)) でJSON をクラスに変換しています。

Firebaseで作っているわけではないと書きましたが、Firebaseを全く使っていないわけではなくて、FCMやAnalytics、In-App Messaging,、RemoteConfig などは利用しています。

### ディレクリ構成について

ディレクトリ構成は下記のようになっています。
誰かと相談して決めたわけではなく、開発を進めていて探り探り分割しているとこのようになっていました。
Flutter からおすすめされているような構成はなく、ディレクトリ構成はアーキテクチャによると思うので参考程度に見てください。

```
app/
  scripts/  # Dart で書かれたスクリプト
  packages/
    commons/  # 社内の共通ライブラリ
    app/  # アプリケーション
      lib/
        controller/  # 各ページのコントローラーとfreezed で書かれたモデル
          mypage/ 
            mypage_controller.dart
            mypage_state.dart
            mypage_state.freezed.dart
        models/
          user/
            user.dart
            user.freezed.dart
            user.g.dart
        pages/
          mypage/
            widgets/  # /pages/mypage にあるクラスからしか使用されないWidget
            mypage.dart
            profile.dart
        resources/
        router/  # ページ遷移に関する処理など
        service/
        utils/
        widgets/  # 共通のWidget
        main.dart  # アプリケーションのエントリーポイント
```


### 状態管理について

Flutter の記事を見ているとまだまだ状態管理についての記事が多く、この記事を読んでいる方もこのサービスではどの状態管理のライブラリーを使用しているのかと気になっている方が多いのではないでしょうか？

状態管理のライブラリーについてですが、Provider を使用しており、StateNotifierを組み合わせて[Provider](https://pub.dev/packages/provider) + [StateNotifier](https://pub.dev/packages/state_notifier) + [freezed](https://pub.dev/packages/freezed) で開発しています。
Riverpod の記事を読めると期待されていた方はすみません...

Provider を採用した理由ついてですが、開発チーム内にアプリの開発だけを行う専任のメンバーが居るわけではなく、色々なメンバーが開発する可能性があったため情報も多く、弊社の他のアプリでも採用しているという理由でProvider を採用しました。
実際私もPython書いたり、PHP書いたり、TypeScript書いたりしています。

Provider の使い方としてはごく普通の使い方で、1ページ、１コントローラー（Provider） なページがほとんどです。コントローラーに処理が多くなると適切に切り分けコントローラーの数が1 + α になることもあります。

### CI/CD
CI ではGithub Actoins を使用しています。
push の度にanalyze やformat が動作するようになっています。

CD ではCodemagic を使用しています。

テスト版の配布は iOS はTestFlight、Android はFirebase App Distribution を使用しています。

設定などに関してはこちらの記事をご確認ください。

https://zenn.dev/0maru/articles/262c0f8ad52a0d#ci%2Fcd-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6

## その他諸々

### freezed について

freezed で作成したクラスに複数のコンストラクターを持たせたい事があるかと思います。
API のレスポンスでJSON を受け取り、fromJson でクラスに変換する際に、変換対象のJSONに
どのコンストラクターを使用するかを判別できるフィールドがJSONにある場合は `unionKey` を使用するとJSON から使用するコンストラクターを決定してクラスを生成することが出来ます。

サンプルコードは freezed のドキュメントから持ってきました。
弊社ではType で表示するWidget を選択するようなことが多いのこの機能はとても重宝しています。

```json
{
  "contents": {
    "items": [
      {
        "runtimeType": "default",
        "a": "This JSON object will use constructor MyResponse()"
      },
      {
        "runtimeType": "special",
        "a": "This JSON object will use constructor MyResponse.special()",
        "b": 42
      },
      {
        "runtimeType": "error",
        "message": "This JSON object will use constructor MyResponse.error()"
      }
    ]
  }
}
```

```
@Freezed(unionKey: 'type', unionValueCase: FreezedUnionCase.pascal)
abstract class MyResponse with _$MyResponse {
  const factory MyResponse(String a) = MyResponseData;

  @FreezedUnionValue('SpecialCase')
  const factory MyResponse.special(String a, int b) = MyResponseSpecial;

  const factory MyResponse.error(String message) = MyResponseError;

  // ...
}
```

https://pub.dev/packages/freezed#fromjson---classes-with-multiple-constructors



### ページ遷移について

アプリとWebで同じAPI を使用しているので例えばトップページ用のAPIのレスポンスは下記のようになっています。

```json
{
  "image": "https://....jpg",
  "url": "/campaign/12332/",
  "description": "画像です",
}
```

画像を表示してタップされた際にurl のページに遷移させたい場合に、Webでは相対パスとしてなんなく処理出来ますがFlutter ではそうはいきません。
Navigator (1.0)を使用しているので下記のコードでページ遷移する必要あります。

```dart
Navigator.of(context).push(
  MaterialPageRouter(
    builder: (context) {
      return CampaignPage();
    },
  ),
);
```

更に検索などではURLにクエリが付加されていて`/search/q=鬼滅の刃&category=1&sort=price-desc&page=1`のようなURLも処理する必要もあります。

どのように処理しているかというと、[MaterialApp](https://api.flutter.dev/flutter/material/MaterialApp-class.html) の[onGenerateRoute](https://api.flutter.dev/flutter/material/MaterialApp/onGenerateRoute.html) にURLを正規表現でページのパスとマッチするかを確認し、マッチした際に遷移するページクラスの決定とクエリをパースしてarguments に変換するようにしています。

このような処理方法を実装することによって、API から返ってくるリンク先が変わったとしてもアプリの修正・リリース無しで動的に変更することが出来ます。

#### 実装例

遷移の際は`pushNamed` を使用します。
pushNamed をコールする際に`arguments` になにかを指定する必要はありません。
MaterialApp.onGenerateRoute でクエリなどが遷移先のクラスのコンストラクタに渡るようになっています。

```dart
Navigator.of(context).pushNamed('/campaign/12332/');

Navigator.of(context).pushNamed('/search/q=鬼滅の刃&category=1&sort=price-desc&page=1');
```

キャンペーンページクラスでは遷移する際のパス（URL）とキャンペーンのIDを受け取るようのクラス変数にid があり、path の `:id` にあるものがクラス変数の`id` 渡されるようになっています。

```dart
class CampaignPage extends StatelessWidget {
  const CampaignPage({Key? key, required this.id}) : super(key: key);

  const String path = '/campaign/:id/';

  final String id;
  ...
}
```

### 決済方法について

このアプリでは実物の漫画を販売しているためアプリ内課金ではなく、クレジットカード決済やAmazonPay、auかんたん決済などの支払い方法を導入しています。
Web版でも同じ決済方法を導入しているため、アプリではSDKを使用せずWeb版と同じRestful APIを使用したAPIベースで実装しています。
実装方法に関しては長くなるので今回は省きますが、一つのソースコードでiOS、Androidの実装が出来るのはやはりクロスプラットフォームのメリットですね！

### Dart SDK について
Flutter のアップデートを行う方は多いと思いますが、プロジェクトで使用しているDart SDK を更新している方は少ないのではないでしょうか？？
特にドキュメントで更新について書かれているページを見た記憶も無いですし、私が知る限りではpubspec.yaml のSDK の項目はupdate のコマンドなどでは自動的に更新されないと認識しています。
まぁ私がSDK の更新に気がついたのもFlutter のアップデートはしたけどタイプエイリアスが使えないなーとのことで気がついたでの、知らない人が多いのではと思っています。

更新したい場合は`pubspec.yaml` を開いて、enviroment.sdk の項目を更新してください。
Stable チャンネルの最新版は`Dart2.15.1` です。

```diff:pubspec.yaml
name: flutter new app.
description: A new Flutter project.
version: 1.0.0+1

environment:
-  sdk: ">=2.12.0 <3.0.0"
+  sdk: ">=2.15.0 <3.0.0"
```




